#!/usr/bin/env bash

set -eu -o pipefail

function usage() {
  printf "usage: %s <jsonfile>

jsonfile: the JSON file generated by fio(1) with \"--output-format=json\"
" "${BASH_SOURCE[0]}"
  exit 0
}

if [[ "$#" -lt 1 ]]; then
  usage
fi

if ! command -v jq > /dev/null 2>&1; then
  echo >&2 "[ERROR] Please install jq before running this script."
  exit 1
fi

jsonfile="$1"
if [[ ! -f "$jsonfile" ]]; then
  echo >&2 "[ERROR] Cannot find JSON file $jsonfile"
  exit 2
fi

declare -A jobname_prefixes=([4k]=4 [16k]=16 [64k]=64 [256k]=256 [1m]=1024 [4m]=4096)

OPERATION=write

for key in "${!jobname_prefixes[@]}"; do
  output=$(jq \
    ".jobs[] |
        select(.jobname | startswith(\"$key\")) |
        .jobname + \" => \" +  (.$OPERATION | .total_ios * ${jobname_prefixes[$key]} / 1024 / (.runtime / 1000) | tostring) + \" MiB/s\"" \
    "$jsonfile")

  if [[ -z "$output" ]]; then
    echo >&2 "[ERROR] Cannot find jobname start with \"$key\""
    echo >&2 "        Did you change the fio job file from which this JSON output is generated?"
    exit 3
  fi

  echo "$output"
done
